{{define "title"}}Администрирование - PhotoCore{{end}}

{{define "styles"}}
/* Admin page - all common styles moved to base.html */
{{end}}

{{define "content"}}
<main class="main-centered">
    <div class="page-header">
        <h1 class="page-title">Управление пользователями</h1>
        <button class="btn btn-primary" onclick="showCreateModal()">+ Добавить пользователя</button>
    </div>

    <div class="card">
        <div class="card-header">
            <span class="card-title">Пользователи</span>
            <span class="text-muted" id="user-count"></span>
        </div>
        <div class="card-body" style="padding: 0;">
            <table class="table" id="users-table">
                <thead>
                    <tr>
                        <th>Пользователь</th>
                        <th>Роль</th>
                        <th>Создан</th>
                        <th>Последний вход</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="users-tbody">
                </tbody>
            </table>
            <div class="empty-state" id="empty-state" style="display: none;">
                <h3>Нет пользователей</h3>
                <p>Добавьте первого пользователя</p>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <span class="card-title">Роли и права</span>
        </div>
        <div class="card-body" style="padding: 0;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Право</th>
                        <th>Admin</th>
                        <th>Editor</th>
                        <th>Viewer</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Просмотр фото и альбомов</td>
                        <td style="color: var(--success);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></td>
                        <td style="color: var(--success);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></td>
                        <td style="color: var(--success);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></td>
                    </tr>
                    <tr>
                        <td>Своё избранное</td>
                        <td style="color: var(--success);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></td>
                        <td style="color: var(--success);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></td>
                        <td style="color: var(--success);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></td>
                    </tr>
                    <tr>
                        <td>Скачивание</td>
                        <td style="color: var(--success);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></td>
                        <td style="color: var(--success);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></td>
                        <td style="color: var(--success);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></td>
                    </tr>
                    <tr>
                        <td>Создание альбомов</td>
                        <td style="color: var(--success);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></td>
                        <td style="color: var(--success);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></td>
                        <td style="color: var(--error);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></td>
                    </tr>
                    <tr>
                        <td>Редактирование альбомов</td>
                        <td style="color: var(--success);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></td>
                        <td style="color: var(--success);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></td>
                        <td style="color: var(--error);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></td>
                    </tr>
                    <tr>
                        <td>Удаление альбомов</td>
                        <td style="color: var(--success);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></td>
                        <td style="color: var(--error);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></td>
                        <td style="color: var(--error);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></td>
                    </tr>
                    <tr>
                        <td>Добавление тегов</td>
                        <td style="color: var(--success);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></td>
                        <td style="color: var(--success);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></td>
                        <td style="color: var(--error);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></td>
                    </tr>
                    <tr>
                        <td>Удаление тегов</td>
                        <td style="color: var(--success);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></td>
                        <td style="color: var(--error);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></td>
                        <td style="color: var(--error);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></td>
                    </tr>
                    <tr>
                        <td>Удаление фото</td>
                        <td style="color: var(--success);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></td>
                        <td style="color: var(--error);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></td>
                        <td style="color: var(--error);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></td>
                    </tr>
                    <tr>
                        <td>Управление пользователями</td>
                        <td style="color: var(--success);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></td>
                        <td style="color: var(--error);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></td>
                        <td style="color: var(--error);"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>
{{end}}

{{define "modals"}}
<!-- Create User Modal -->
<div class="modal" id="create-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Создать пользователя</h2>
            <button class="modal-close" onclick="closeModal('create-modal')"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Логин</label>
                <input type="text" class="form-input" id="create-username" placeholder="username" autocomplete="off">
                <div class="form-hint">Только латинские буквы и цифры</div>
            </div>
            <div class="form-group">
                <label>Отображаемое имя</label>
                <input type="text" class="form-input" id="create-display-name" placeholder="Иван Иванов">
            </div>
            <div class="form-group">
                <label>Пароль</label>
                <input type="password" class="form-input" id="create-password" placeholder="Минимум 6 символов">
            </div>
            <div class="form-group">
                <label>Роль</label>
                <select class="form-select" id="create-role">
                    <option value="viewer">Viewer - только просмотр</option>
                    <option value="editor">Editor - создание альбомов, теги</option>
                    <option value="admin">Admin - полный доступ</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('create-modal')">Отмена</button>
            <button class="btn btn-primary" onclick="createUser()">Создать</button>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal" id="edit-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Редактировать пользователя</h2>
            <button class="modal-close" onclick="closeModal('edit-modal')"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="edit-username">
            <div class="form-group">
                <label>Логин</label>
                <input type="text" class="form-input" id="edit-username-display" disabled>
            </div>
            <div class="form-group">
                <label>Отображаемое имя</label>
                <input type="text" class="form-input" id="edit-display-name" placeholder="Иван Иванов">
            </div>
            <div class="form-group">
                <label>Новый пароль</label>
                <input type="password" class="form-input" id="edit-password" placeholder="Оставьте пустым, чтобы не менять">
            </div>
            <div class="form-group">
                <label>Роль</label>
                <select class="form-select" id="edit-role">
                    <option value="viewer">Viewer - только просмотр</option>
                    <option value="editor">Editor - создание альбомов, теги</option>
                    <option value="admin">Admin - полный доступ</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('edit-modal')">Отмена</button>
            <button class="btn btn-primary" onclick="updateUser()">Сохранить</button>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
// State
let users = [];
const currentUsername = '{{.Username}}';

// Load users on page load
document.addEventListener('DOMContentLoaded', loadUsers);

function loadUsers() {
    fetch('/api/users')
        .then(r => r.json())
        .then(data => {
            users = data || [];
            renderUsers();
        })
        .catch(err => showToast('Ошибка загрузки: ' + err.message, 'error'));
}

function renderUsers() {
    const tbody = document.getElementById('users-tbody');
    const empty = document.getElementById('empty-state');
    const count = document.getElementById('user-count');

    if (users.length === 0) {
        tbody.innerHTML = '';
        empty.style.display = 'block';
        count.textContent = '';
        return;
    }

    empty.style.display = 'none';
    count.textContent = users.length + ' пользователей';

    tbody.innerHTML = users.map(user => {
        const roleClass = 'role-' + user.role;
        const roleLabel = user.role === 'admin' ? 'Admin' : (user.role === 'editor' ? 'Editor' : 'Viewer');
        const createdAt = user.created_at ? formatDate(user.created_at) : '-';
        const lastLogin = user.last_login && user.last_login !== '0001-01-01T00:00:00Z' ? formatDate(user.last_login) : 'Никогда';
        const displayName = user.display_name || user.username;
        const isSelf = user.username === currentUsername;

        return `
            <tr>
                <td>
                    <strong>${escapeHtml(displayName)}</strong>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">@${escapeHtml(user.username)}</div>
                </td>
                <td><span class="role-badge ${roleClass}">${roleLabel}</span></td>
                <td class="date-cell">${createdAt}</td>
                <td class="date-cell">${lastLogin}</td>
                <td class="actions-cell">
                    <button class="btn btn-secondary btn-sm" onclick="showEditModal('${escapeHtml(user.username)}')">Изменить</button>
                    ${isSelf ? '' : `<button class="btn btn-danger btn-sm" onclick="deleteUser('${escapeHtml(user.username)}')">Удалить</button>`}
                </td>
            </tr>
        `;
    }).join('');
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Modals
function showCreateModal() {
    document.getElementById('create-username').value = '';
    document.getElementById('create-display-name').value = '';
    document.getElementById('create-password').value = '';
    document.getElementById('create-role').value = 'viewer';
    document.getElementById('create-modal').classList.add('active');
    document.getElementById('create-username').focus();
}

function showEditModal(username) {
    const user = users.find(u => u.username === username);
    if (!user) return;

    document.getElementById('edit-username').value = user.username;
    document.getElementById('edit-username-display').value = user.username;
    document.getElementById('edit-display-name').value = user.display_name || '';
    document.getElementById('edit-password').value = '';
    document.getElementById('edit-role').value = user.role;
    document.getElementById('edit-modal').classList.add('active');
}

// CRUD operations
function createUser() {
    const username = document.getElementById('create-username').value.trim();
    const displayName = document.getElementById('create-display-name').value.trim();
    const password = document.getElementById('create-password').value;
    const role = document.getElementById('create-role').value;

    if (!username || !password) {
        showToast('Заполните логин и пароль', 'error');
        return;
    }

    if (password.length < 6) {
        showToast('Пароль должен быть минимум 6 символов', 'error');
        return;
    }

    fetch('/api/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            username: username,
            display_name: displayName,
            password: password,
            role: role
        })
    })
    .then(r => {
        if (!r.ok) return r.json().then(err => { throw new Error(err.error || 'Ошибка'); });
        return r.json();
    })
    .then(() => {
        showToast('Пользователь создан', 'success');
        closeModal('create-modal');
        loadUsers();
    })
    .catch(err => showToast(err.message, 'error'));
}

function updateUser() {
    const username = document.getElementById('edit-username').value;
    const displayName = document.getElementById('edit-display-name').value.trim();
    const password = document.getElementById('edit-password').value;
    const role = document.getElementById('edit-role').value;

    const data = { role: role };
    if (displayName) data.display_name = displayName;
    if (password) {
        if (password.length < 6) {
            showToast('Пароль должен быть минимум 6 символов', 'error');
            return;
        }
        data.password = password;
    }

    fetch('/api/users/' + encodeURIComponent(username), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(r => {
        if (!r.ok) return r.json().then(err => { throw new Error(err.error || 'Ошибка'); });
        return r.json();
    })
    .then(() => {
        showToast('Пользователь обновлен', 'success');
        closeModal('edit-modal');
        loadUsers();
    })
    .catch(err => showToast(err.message, 'error'));
}

function deleteUser(username) {
    if (!confirm('Удалить пользователя "' + username + '"?')) return;

    fetch('/api/users/' + encodeURIComponent(username), {
        method: 'DELETE'
    })
    .then(r => {
        if (!r.ok) return r.json().then(err => { throw new Error(err.error || 'Ошибка'); });
        return r.json();
    })
    .then(() => {
        showToast('Пользователь удален', 'success');
        loadUsers();
    })
    .catch(err => showToast(err.message, 'error'));
}

// Close modal on click outside
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('active');
        }
    });
});

// Close modal on Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active'));
    }
});
{{end}}

{{define "title"}}Поиск - PhotoCore{{end}}

{{define "head"}}
<script src="/static/js/htmx.min.js?v={{.BuildVersion}}"></script>
<script src="/static/js/lightbox.js?v={{.BuildVersion}}"></script>
{{end}}

{{define "styles"}}
/* Search page - most styles now in base.html */
.tag-chips {
    margin-top: var(--spacing-md);
}

/* Hide search button text on mobile */
@media (max-width: 600px) {
    .search-btn-text {
        display: none;
    }
    .search-btn {
        padding: 0 var(--md-spacing-3);
        min-width: 40px;
    }
}
{{end}}

{{define "content"}}
<main class="main-centered">
    <div class="search-box">
        <form id="search-form" hx-get="/api/search" hx-target="#results" hx-trigger="submit">
            <div class="search-row">
                <input type="text" name="q" class="search-input" placeholder="Поиск по имени файла, камере, объективу...">
                <button type="submit" class="md-button md-button-filled search-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    <span class="search-btn-text">Найти</span>
                </button>
            </div>
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Тип</label>
                    <select name="type" class="filter-select">
                        <option value="">Все</option>
                        <option value="image">Фото</option>
                        <option value="video">Видео</option>
                        <option value="raw">RAW</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Камера</label>
                    <select name="camera" class="filter-select">
                        <option value="">Все камеры</option>
                        {{range .Cameras}}
                        <option value="{{.}}">{{.}}</option>
                        {{end}}
                    </select>
                </div>
                <div class="filter-group">
                    <label>От даты</label>
                    <input type="date" name="from" class="filter-input">
                </div>
                <div class="filter-group">
                    <label>До даты</label>
                    <input type="date" name="to" class="filter-input">
                </div>
                <div class="filter-group">
                    <label>
                        <input type="checkbox" name="favorite" value="true"> Только избранное
                    </label>
                </div>
                <div class="filter-group">
                    <label>
                        <input type="checkbox" name="gps" value="true"> С геолокацией
                    </label>
                </div>
            </div>
            {{if .Tags}}
            <div class="tag-chips" style="display: flex; flex-wrap: wrap; gap: var(--md-spacing-2);">
                {{range .Tags}}
                <button type="button" class="md-chip md-chip-filter tag-chip" onclick="toggleTag(this, '{{.Name}}')">
                    <span>{{.Name}}</span>
                    <span style="color: var(--md-on-surface-variant); margin-left: 4px;">({{.MediaCount}})</span>
                </button>
                {{end}}
            </div>
            <input type="hidden" name="tags" id="selected-tags" value="">
            {{end}}
        </form>
    </div>

    <div id="results"></div>
</main>
{{end}}

{{define "scripts"}}
let selectedTags = [];
// Инициализируем глобальный favSet
window.favSet = new Set([{{range $id, $_ := .FavSet}}"{{$id}}",{{end}}]);

function updateFavoriteBadges() {
    document.querySelectorAll('.media-card').forEach(card => {
        const badge = card.querySelector('.favorite-badge');
        if (badge && window.favSet.has(card.dataset.id)) {
            badge.classList.add('active');
        }
    });
}

document.body.addEventListener('htmx:afterSwap', function() {
    updateFavoriteBadges();
});

function toggleTag(el, tag) {
    const idx = selectedTags.indexOf(tag);
    if (idx >= 0) {
        selectedTags.splice(idx, 1);
        el.classList.remove('selected');
    } else {
        selectedTags.push(tag);
        el.classList.add('selected');
    }
    document.getElementById('selected-tags').value = selectedTags.join(',');
}
{{end}}

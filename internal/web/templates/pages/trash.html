{{define "title"}}Корзина - PhotoCore{{end}}

{{define "styles"}}
/* Trash page specific styles */
.trash-actions {
    display: flex;
    gap: var(--spacing-sm);
}

.trash-card {
    position: relative;
    border-radius: var(--radius-sm);
    background: var(--md-surface-container);
    cursor: pointer;
    overflow: visible;
}
.trash-card > img {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
    opacity: 0.7;
    border-radius: var(--radius-sm);
    transition: opacity var(--transition-fast);
}
.trash-card:hover > img {
    opacity: 1;
}

.trash-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.9));
    padding: var(--spacing-md) var(--spacing-sm) var(--spacing-sm);
    border-radius: 0 0 var(--radius-sm) var(--radius-sm);
}
.trash-filename {
    font-size: 0.75rem;
    color: #fff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: var(--spacing-xs);
}
.trash-days {
    font-size: 0.7rem;
    color: var(--md-error);
}
.trash-days.warning {
    color: var(--md-warning);
}
.trash-days.ok {
    color: var(--text-muted);
}

.trash-actions-card {
    position: absolute;
    top: var(--spacing-sm);
    right: var(--spacing-sm);
    display: flex;
    gap: var(--spacing-xs);
    opacity: 0;
    transition: opacity var(--transition-fast);
}
.trash-card:hover .trash-actions-card {
    opacity: 1;
}

.action-btn {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: var(--radius-xs);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    transition: background-color var(--transition-fast);
}
.restore-btn {
    background: rgba(125, 217, 144, 0.9);
    color: var(--md-on-tertiary);
}
.restore-btn:hover {
    background: var(--md-tertiary);
}
.delete-btn {
    background: rgba(255, 180, 171, 0.9);
    color: var(--md-on-error);
}
.delete-btn:hover {
    background: var(--md-error);
}

.duplicate-badge {
    position: absolute;
    top: var(--spacing-sm);
    left: var(--spacing-sm);
    background: var(--md-warning);
    color: #000;
    font-size: 0.65rem;
    font-weight: bold;
    padding: 2px 6px;
    border-radius: var(--radius-xs);
    z-index: 10;
}
.trash-card[onclick] {
    cursor: pointer;
}

/* Compare modal */
.compare-modal {
    background: rgba(0,0,0,0.9);
    z-index: 2000;
}
.compare-content {
    background: var(--md-surface-container);
    border-radius: var(--radius-md);
    padding: var(--spacing-lg);
    max-width: 700px;
    width: 90%;
}
.compare-title {
    text-align: center;
    font-size: 1.1rem;
    margin-bottom: var(--spacing-lg);
    color: var(--text-primary);
}
.compare-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
}
.compare-item {
    text-align: center;
}
.compare-label {
    font-size: 0.8rem;
    font-weight: bold;
    padding: 4px 12px;
    border-radius: var(--radius-xs);
    margin-bottom: 0.75rem;
    display: inline-block;
}
.compare-item.duplicate .compare-label {
    background: var(--md-error-container);
    color: var(--md-on-error-container);
}
.compare-item.original .compare-label {
    background: var(--md-tertiary-container);
    color: var(--md-on-tertiary-container);
}
.compare-item img {
    width: 100%;
    max-width: 280px;
    aspect-ratio: 1;
    object-fit: cover;
    border-radius: var(--radius-sm);
    margin-bottom: 0.75rem;
}
.compare-info {
    font-size: 0.75rem;
    color: var(--text-secondary);
    line-height: 1.4;
}
.compare-info strong {
    color: var(--text-primary);
}
.compare-actions {
    display: flex;
    gap: var(--spacing-md);
    justify-content: center;
    flex-wrap: wrap;
}
.compare-actions .btn {
    min-width: 140px;
}

/* Confirm modal */
.confirm-content {
    text-align: center;
    max-width: 400px;
}
.confirm-content h3 {
    margin-bottom: var(--spacing-md);
}
.confirm-content p {
    color: var(--text-secondary);
    margin-bottom: var(--spacing-lg);
}
.confirm-buttons {
    display: flex;
    gap: var(--spacing-md);
    justify-content: center;
}
{{end}}

{{define "content"}}
<main class="main">
    <div class="page-header">
        <h1 class="page-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
            </svg>
            Корзина
            {{if .TrashCount}}<span style="font-size: 0.9rem; color: #888;">({{.TrashCount}})</span>{{end}}
        </h1>
        {{if .TrashItems}}
        <div class="trash-actions">
            <button class="btn btn-danger" onclick="showEmptyConfirm()">Очистить корзину</button>
        </div>
        {{end}}
    </div>

    {{if .TrashItems}}
    <div class="alert alert-warning">
        Файлы в корзине автоматически удаляются через 30 дней. Вы можете восстановить их или удалить вручную.
    </div>

    <div class="grid">
        {{range .TrashItems}}
        <div class="trash-card" data-id="{{.ID}}" {{if .DuplicateOf}}onclick="showCompare('{{.ID}}', '{{.DuplicateOf}}', event)"{{end}}>
            <img src="/media/{{.ID}}/thumb/small" alt="{{.Filename}}" loading="lazy">
            {{if .DuplicateOf}}
            <span class="duplicate-badge">Дубликат</span>
            {{end}}
            <div class="trash-actions-card">
                <button class="action-btn restore-btn" onclick="restoreMedia('{{.ID}}', event)" title="Восстановить">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9z"/></svg>
                </button>
                <button class="action-btn delete-btn" onclick="deleteMedia('{{.ID}}', event)" title="Удалить навсегда">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
            <div class="trash-overlay">
                <div class="trash-filename">{{.Filename}}</div>
                <div class="trash-days {{if le .DaysRemaining 3}}warning{{else if le .DaysRemaining 7}}warning{{else}}ok{{end}}">
                    {{if le .DaysRemaining 0}}Будет удалено сегодня{{else}}Осталось {{.DaysRemaining}} дн.{{end}}
                </div>
            </div>
        </div>
        {{end}}
    </div>
    {{else}}
    <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.5">
            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
        </svg>
        <h3>Корзина пуста</h3>
        <p>Удалённые файлы появятся здесь</p>
    </div>
    {{end}}
</main>

<!-- Модальное окно сравнения дубликатов -->
<div class="modal compare-modal" id="compareModal" onclick="if(event.target === this) hideCompare()">
    <div class="compare-content">
        <div class="compare-title">Сравнение дубликата с оригиналом</div>
        <div class="compare-grid">
            <div class="compare-item duplicate">
                <div class="compare-label">Дубликат</div>
                <img id="compareDupImg" src="" alt="Дубликат">
                <div class="compare-info" id="compareDupInfo"></div>
            </div>
            <div class="compare-item original">
                <div class="compare-label">Оригинал</div>
                <img id="compareOrigImg" src="" alt="Оригинал">
                <div class="compare-info" id="compareOrigInfo"></div>
            </div>
        </div>
        <div class="compare-actions">
            <button class="btn btn-secondary" onclick="hideCompare()">Закрыть</button>
            <button class="btn btn-success" id="replaceBtn" onclick="replaceDuplicate()">Заменить оригинал</button>
        </div>
    </div>
</div>

<div class="modal" id="emptyConfirm">
    <div class="modal-content confirm-content">
        <h3>Очистить корзину?</h3>
        <p>Все файлы будут удалены безвозвратно. Это действие нельзя отменить.</p>
        <div class="confirm-buttons">
            <button class="btn btn-secondary" onclick="hideEmptyConfirm()">Отмена</button>
            <button class="btn btn-danger" onclick="emptyTrash()">Удалить всё</button>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
let currentDuplicateId = null;
let currentOriginalId = null;

function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function showCompare(dupId, origId, event) {
    event.stopPropagation();
    currentDuplicateId = dupId;
    currentOriginalId = origId;

    // Устанавливаем картинки
    document.getElementById('compareDupImg').src = '/media/' + dupId + '/thumb/large';
    document.getElementById('compareOrigImg').src = '/media/' + origId + '/thumb/large';

    // Загружаем информацию о файлах
    Promise.all([
        fetch('/api/media/' + dupId).then(r => r.json()),
        fetch('/api/media/' + origId).then(r => r.json())
    ]).then(([dup, orig]) => {
        document.getElementById('compareDupInfo').innerHTML =
            '<strong>' + dup.filename + '</strong><br>' +
            (dup.width && dup.height ? dup.width + ' × ' + dup.height + '<br>' : '') +
            formatSize(dup.size);

        document.getElementById('compareOrigInfo').innerHTML =
            '<strong>' + orig.filename + '</strong><br>' +
            (orig.width && orig.height ? orig.width + ' × ' + orig.height + '<br>' : '') +
            formatSize(orig.size);
    }).catch(err => {
        console.error('Error loading media info:', err);
    });

    document.getElementById('compareModal').classList.add('active');
}

function hideCompare() {
    document.getElementById('compareModal').classList.remove('active');
    currentDuplicateId = null;
    currentOriginalId = null;
}

function replaceDuplicate() {
    if (!currentDuplicateId || !currentOriginalId) return;

    if (!confirm('Заменить оригинал на дубликат? Оригинал будет перемещён в корзину.')) return;

    fetch('/api/duplicates/replace', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            duplicate_id: currentDuplicateId,
            original_id: currentOriginalId
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'replaced') {
            hideCompare();
            showToast('Оригинал заменён на дубликат', 'success');
            setTimeout(() => window.location.reload(), 500);
        } else {
            showToast('Ошибка: ' + (data.error || 'неизвестная ошибка'), 'error');
        }
    })
    .catch(err => showToast('Ошибка: ' + err.message, 'error'));
}

function restoreMedia(id, event) {
    event.stopPropagation();
    fetch('/api/trash/' + id + '/restore', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'restored') {
                event.target.closest('.trash-card').remove();
                showToast('Файл восстановлен', 'success');
                updateCount();
            }
        })
        .catch(err => showToast('Ошибка: ' + err.message, 'error'));
}

function deleteMedia(id, event) {
    event.stopPropagation();
    if (!confirm('Удалить файл безвозвратно?')) return;

    fetch('/api/trash/' + id, { method: 'DELETE' })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'deleted') {
                event.target.closest('.trash-card').remove();
                showToast('Файл удалён навсегда', 'success');
                updateCount();
            }
        })
        .catch(err => showToast('Ошибка: ' + err.message, 'error'));
}

function showEmptyConfirm() {
    document.getElementById('emptyConfirm').classList.add('active');
}

function hideEmptyConfirm() {
    document.getElementById('emptyConfirm').classList.remove('active');
}

function emptyTrash() {
    fetch('/api/trash', { method: 'DELETE' })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'emptied') {
                showToast('Корзина очищена', 'success');
                setTimeout(() => window.location.reload(), 500);
            }
        })
        .catch(err => showToast('Ошибка: ' + err.message, 'error'));
}

function updateCount() {
    const count = document.querySelectorAll('.trash-card').length;
    if (count === 0) {
        window.location.reload();
    }
}
{{end}}

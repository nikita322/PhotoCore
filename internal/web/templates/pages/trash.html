{{define "title"}}Корзина - PhotoCore{{end}}

{{define "styles"}}
/* Trash page specific styles */
/* (Card styles are now in media_card_styles component) */

.trash-actions {
    display: flex;
    gap: var(--spacing-sm);
}

/* Compare modal */
.compare-modal {
    background: var(--md-scrim-heavy);
    z-index: 2000;
}
.compare-content {
    background: var(--md-surface-container);
    border-radius: var(--radius-md);
    padding: var(--spacing-lg);
    max-width: 700px;
    width: 90%;
}
.compare-title {
    text-align: center;
    font-size: 1.1rem;
    margin-bottom: var(--spacing-lg);
    color: var(--text-primary);
}
.compare-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
}
.compare-item {
    text-align: center;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
}
.compare-label {
    font-size: 0.8rem;
    font-weight: bold;
    padding: 4px 12px;
    border-radius: var(--radius-xs);
    margin-bottom: 0.75rem;
    display: inline-block;
}
.compare-item.duplicate .compare-label {
    background: var(--md-error-container);
    color: var(--md-on-error-container);
}
.compare-item.original .compare-label {
    background: var(--md-tertiary-container);
    color: var(--md-on-tertiary-container);
}
.compare-item img {
    width: 100%;
    max-width: 280px;
    aspect-ratio: 1;
    object-fit: cover;
    border-radius: var(--radius-sm);
    margin-bottom: 0.75rem;
    background: var(--md-surface-container-high);
    transition: opacity 0.3s;
}
.compare-item img.loading { opacity: 0; }
.compare-item img.loaded { opacity: 1; }
.compare-item img.error { opacity: 0.3; }
.compare-info {
    font-size: 0.75rem;
    color: var(--text-secondary);
    line-height: 1.4;
}
.compare-info strong {
    color: var(--text-primary);
}
.compare-actions {
    display: flex;
    gap: var(--spacing-md);
    justify-content: center;
    flex-wrap: wrap;
}
.compare-actions .btn {
    min-width: 140px;
}

/* Confirm modal */
.confirm-content {
    text-align: center;
    max-width: 400px;
}
.confirm-content h3 {
    margin-bottom: var(--spacing-md);
}
.confirm-content p {
    color: var(--text-secondary);
    margin-bottom: var(--spacing-lg);
}
.confirm-buttons {
    display: flex;
    gap: var(--spacing-md);
    justify-content: center;
}

/* Trash-specific utility */
.trash-count {
    font-size: 0.9rem;
    color: var(--text-muted);
}
{{end}}

{{define "content"}}
<main class="main">
    <div class="page-header">
        <h1 class="page-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
            </svg>
            Корзина
            {{if .TrashCount}}<span class="trash-count">({{.TrashCount}})</span>{{end}}
        </h1>
        {{if .TrashItems}}
        <div class="trash-actions">
            <button class="md-button md-button-outlined btn-error" onclick="showEmptyConfirm()">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                Очистить корзину
            </button>
        </div>
        {{end}}
    </div>

    {{if .TrashItems}}
    <div class="alert alert-warning">
        Файлы в корзине автоматически удаляются через 30 дней. Вы можете восстановить их или удалить вручную.
    </div>

    <div class="grid">
        {{range .TrashItems}}
        {{$onClick := ""}}
        {{if .DuplicateOf}}
            {{$onClick = printf "console.log('Trash card clicked:', '%s', '%s'); showCompare('%s', '%s', event)" .ID .DuplicateOf .ID .DuplicateOf}}
        {{else}}
            {{$takenAt := ""}}{{if not .TakenAt.IsZero}}{{$takenAt = .TakenAt.Format "2006-01-02T15:04:05Z07:00"}}{{end}}
            {{$meta := ""}}{{if .Metadata.Camera}}{{$meta = .Metadata.Camera}}{{end}}{{if .Metadata.Aperture}}{{$meta = printf "%s • %s" $meta .Metadata.Aperture}}{{end}}{{if .Metadata.ShutterSpeed}}{{$meta = printf "%s • %s" $meta .Metadata.ShutterSpeed}}{{end}}{{if .Metadata.ISO}}{{$meta = printf "%s • ISO %s" $meta .Metadata.ISO}}{{end}}
            {{$onClick = printf "console.log('Trash card clicked:', '%s'); openLightbox('%s', '%s', '%s', '%s')" .ID .ID .Filename $takenAt $meta}}
        {{end}}
        {{template "media_card" (dict "Media" . "Mode" "trash" "DuplicateOf" .DuplicateOf "DaysRemaining" .DaysRemaining "OnClick" $onClick "ShowFavorite" false)}}
        {{end}}
    </div>
    {{else}}
    <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
        </svg>
        <h3>Корзина пуста</h3>
        <p>Удалённые файлы появятся здесь</p>
    </div>
    {{end}}
</main>

<!-- Модальное окно сравнения дубликатов -->
<div class="modal compare-modal" id="compareModal" onclick="if(event.target === this) hideCompare()">
    <div class="compare-content">
        <div class="compare-title">Сравнение дубликата с оригиналом</div>
        <div class="compare-grid">
            <div class="compare-item duplicate">
                <div class="compare-label">Дубликат</div>
                <img id="compareDupImg" alt="Дубликат">
                <div class="compare-info" id="compareDupInfo"></div>
            </div>
            <div class="compare-item original">
                <div class="compare-label">Оригинал</div>
                <img id="compareOrigImg" alt="Оригинал">
                <div class="compare-info" id="compareOrigInfo"></div>
            </div>
        </div>
        <div class="compare-actions">
            <button class="md-button md-button-text" onclick="hideCompare()">Закрыть</button>
            <button class="md-button md-button-outlined" onclick="removeDuplicateStatus()">Сохранить оба</button>
            <button class="md-button md-button-filled btn-tertiary-filled" id="replaceBtn" onclick="replaceDuplicate()">Заменить оригинал</button>
        </div>
    </div>
</div>

<div class="modal" id="emptyConfirm">
    <div class="modal-content confirm-content">
        <h3>Очистить корзину?</h3>
        <p>Все файлы будут удалены безвозвратно. Это действие нельзя отменить.</p>
        <div class="confirm-buttons">
            <button class="md-button md-button-text" onclick="hideEmptyConfirm()">Отмена</button>
            <button class="md-button md-button-filled btn-error-filled" onclick="emptyTrash()">Удалить всё</button>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
// Инициализируем глобальный favSet
window.favSet = new Set([{{range $id, $_ := .FavSet}}"{{$id}}",{{end}}]);

let currentDuplicateId = null;
let currentOriginalId = null;

function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function showCompare(dupId, origId, event) {
    console.log('showCompare called:', { dupId, origId, event });
    event.stopPropagation();

    currentDuplicateId = dupId;
    currentOriginalId = origId;

    // Получаем изображения и очищаем src для показа skeleton
    const dupImg = document.getElementById('compareDupImg');
    const origImg = document.getElementById('compareOrigImg');

    // Убираем src и класс loaded чтобы показать skeleton анимацию
    dupImg.removeAttribute('src');
    origImg.removeAttribute('src');
    dupImg.classList.remove('loaded');
    origImg.classList.remove('loaded');
    dupImg.style.opacity = '0.7';
    origImg.style.opacity = '0.7';

    // Запускаем загрузку с retry механизмом
    loadImageWithRetry(dupImg, '/media/' + dupId + '/thumb/large');
    loadImageWithRetry(origImg, '/media/' + origId + '/thumb/large');

    // Загружаем информацию о файлах
    Promise.all([
        fetch('/api/media/' + dupId).then(r => r.json()),
        fetch('/api/media/' + origId).then(r => r.json())
    ]).then(([dup, orig]) => {
        document.getElementById('compareDupInfo').innerHTML =
            '<strong>' + dup.filename + '</strong><br>' +
            (dup.width && dup.height ? dup.width + ' × ' + dup.height + '<br>' : '') +
            formatSize(dup.size);

        document.getElementById('compareOrigInfo').innerHTML =
            '<strong>' + orig.filename + '</strong><br>' +
            (orig.width && orig.height ? orig.width + ' × ' + orig.height + '<br>' : '') +
            formatSize(orig.size);
    }).catch(err => {
        console.error('Error loading media info:', err);
    });

    document.getElementById('compareModal').classList.add('active');
}

function hideCompare() {
    document.getElementById('compareModal').classList.remove('active');
    currentDuplicateId = null;
    currentOriginalId = null;
}

function replaceDuplicate() {
    if (!currentDuplicateId || !currentOriginalId) return;

    if (!confirm('Заменить оригинал на дубликат? Оригинал будет перемещён в корзину.')) return;

    fetch('/api/duplicates/replace', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            duplicate_id: currentDuplicateId,
            original_id: currentOriginalId
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'replaced') {
            hideCompare();
            showToast('Оригинал заменён на дубликат', 'success');
            setTimeout(() => window.location.reload(), 500);
        } else {
            showToast('Ошибка: ' + (data.error || 'неизвестная ошибка'), 'error');
        }
    })
    .catch(err => showToast('Ошибка: ' + err.message, 'error'));
}

function removeDuplicateStatus() {
    if (!currentDuplicateId) return;

    if (!confirm('Снять статус дубликата? Фото станет обычным и будет видимым в галерее.')) return;

    fetch('/api/duplicates/unmark', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            media_id: currentDuplicateId
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'unmarked') {
            hideCompare();
            showToast('Статус дубликата снят. Фото сохранено.', 'success');
            setTimeout(() => window.location.reload(), 500);
        } else {
            showToast('Ошибка: ' + (data.error || 'неизвестная ошибка'), 'error');
        }
    })
    .catch(err => showToast('Ошибка: ' + err.message, 'error'));
}

function restoreMedia(id, event) {
    event.stopPropagation();
    fetch('/api/trash/' + id + '/restore', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'restored') {
                event.target.closest('.media-card').remove();
                showToast('Файл восстановлен', 'success');
                updateCount();
            }
        })
        .catch(err => showToast('Ошибка: ' + err.message, 'error'));
}

function deleteMedia(id, event) {
    event.stopPropagation();
    if (!confirm('Удалить файл безвозвратно?')) return;

    fetch('/api/trash/' + id, { method: 'DELETE' })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'deleted') {
                event.target.closest('.media-card').remove();
                showToast('Файл удалён навсегда', 'success');
                updateCount();
            }
        })
        .catch(err => showToast('Ошибка: ' + err.message, 'error'));
}

function showEmptyConfirm() {
    document.getElementById('emptyConfirm').classList.add('active');
}

function hideEmptyConfirm() {
    document.getElementById('emptyConfirm').classList.remove('active');
}

function emptyTrash() {
    fetch('/api/trash', { method: 'DELETE' })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'emptied') {
                showToast('Корзина очищена', 'success');
                setTimeout(() => window.location.reload(), 500);
            }
        })
        .catch(err => showToast('Ошибка: ' + err.message, 'error'));
}

function updateCount() {
    const count = document.querySelectorAll('.media-card').length;
    if (count === 0) {
        window.location.reload();
    }
}

// Очистка кэша миниатюр при загрузке страницы
async function clearMediaCache() {
    if ('caches' in window) {
        try {
            const cacheNames = await caches.keys();
            for (const cacheName of cacheNames) {
                if (cacheName.includes('photocore-media')) {
                    console.log('[Trash] Clearing media cache:', cacheName);
                    await caches.delete(cacheName);
                }
            }
            console.log('[Trash] Media cache cleared');
        } catch (error) {
            console.warn('[Trash] Failed to clear cache:', error);
        }
    }
}

// Загружает все изображения со страницы используя data-src
function loadAllThumbnails() {
    const images = document.querySelectorAll('img[data-src]');
    console.log('[Trash] Loading', images.length, 'thumbnails');

    images.forEach(img => {
        const src = img.dataset.src;
        if (src) {
            loadImageWithRetry(img, src);
        }
    });
}

// Очищаем кэш и загружаем миниатюры при загрузке страницы
clearMediaCache().then(() => {
    loadAllThumbnails();
});
{{end}}

{{define "title"}}Галерея - PhotoCore{{end}}

{{define "head"}}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
{{end}}

{{define "body_attrs"}}data-role="{{.Role}}" data-is-admin="{{.IsAdmin}}" data-can-edit="{{.CanEdit}}"{{end}}

{{define "styles"}}
/* Bulk Actions Bar */
.bulk-actions-bar {
    display: none;
    background-color: var(--md-surface-container);
    border-bottom: 1px solid var(--border);
    padding: 0.75rem var(--spacing-xl);
    justify-content: space-between;
    align-items: center;
}
.bulk-actions-bar.active { display: flex; }
.bulk-info { display: flex; align-items: center; gap: var(--spacing-md); }
.bulk-buttons { display: flex; gap: var(--spacing-sm); flex-wrap: wrap; }

/* Container */
.container { display: flex; min-height: calc(100vh - 60px); }

/* Sidebar */
.sidebar {
    width: 300px;
    background-color: var(--md-surface-container);
    border-right: 1px solid var(--border);
    overflow-y: auto;
    position: sticky;
    top: 60px;
    height: calc(100vh - 60px);
    flex-shrink: 0;
}
.sidebar-header {
    padding: var(--spacing-md);
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.sidebar-title {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--text-muted);
    letter-spacing: 0.05em;
}
.all-photos-btn {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: 0.75rem var(--spacing-md);
    margin: var(--spacing-sm);
    background: var(--md-surface-container-high);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all var(--transition-fast);
}
.all-photos-btn:hover {
    background: var(--md-primary-container);
    color: var(--md-on-primary-container);
}
.all-photos-btn svg { flex-shrink: 0; }
.timeline-list { list-style: none; }
.year-header {
    font-size: 1.1rem;
    font-weight: 600;
    padding: 0.75rem var(--spacing-md);
    background-color: var(--md-surface-container-high);
    color: var(--text-primary);
    position: sticky;
    top: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.year-header .year-select {
    opacity: 0;
    transition: opacity var(--transition-fast);
}
.year-header:hover .year-select,
body.select-mode .year-header .year-select { opacity: 1; }
.timeline-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.6rem var(--spacing-md);
    cursor: pointer;
    border-left: 3px solid transparent;
    transition: all var(--transition-fast);
}
.timeline-item:hover { background-color: var(--md-surface-container-high); }
.timeline-item.active {
    background-color: var(--md-surface-container-high);
    border-left-color: var(--md-primary);
}
.timeline-item-info { display: flex; align-items: center; gap: 0.75rem; flex: 1; }
.timeline-label { font-weight: 500; }
.timeline-count {
    color: var(--text-secondary);
    font-size: 0.8rem;
    background-color: var(--md-surface-container-highest);
    padding: 0.15rem var(--spacing-sm);
    border-radius: var(--radius-full);
}
.period-checkbox {
    width: 18px;
    height: 18px;
    opacity: 0;
    transition: opacity var(--transition-fast);
    cursor: pointer;
    accent-color: var(--md-primary);
}
.timeline-item:hover .period-checkbox,
body.select-mode .period-checkbox { opacity: 1; }
.period-checkbox:checked { opacity: 1; }

/* Main Content - Override base */
.main {
    flex: 1;
    padding: var(--spacing-lg);
    overflow-y: auto;
}
.main-header {
    margin-bottom: var(--spacing-lg);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.main-title { font-size: 1.25rem; }
.main-actions { display: flex; gap: var(--spacing-sm); }
.main-subtitle { color: var(--text-secondary); font-size: 0.875rem; }

/* Selection Mode */
body.select-mode .media-card::before {
    content: '';
    position: absolute;
    top: 0.4rem;
    left: 0.4rem;
    width: 22px;
    height: 22px;
    border: 2px solid var(--md-white);
    border-radius: var(--radius-full);
    background-color: var(--md-scrim-light);
    z-index: 10;
}
body.select-mode .media-card.selected::before {
    background-color: var(--md-primary);
    border-color: var(--md-primary);
}
body.select-mode .media-card.selected::after {
    content: '\2713';
    position: absolute;
    top: 0.4rem;
    left: 0.4rem;
    width: 22px;
    height: 22px;
    color: var(--md-on-primary);
    font-size: 13px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 11;
}

/* Section */
.section { margin-bottom: var(--spacing-xl); }
.section-title {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
}
.period-header-inline {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    text-transform: none;
    letter-spacing: normal;
    padding: var(--spacing-sm) 0;
    margin-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    transition: color var(--transition-fast);
}
.period-header-inline:hover { color: var(--md-primary); }
.period-header-inline .period-count {
    font-size: 0.85rem;
    color: var(--text-secondary);
    font-weight: normal;
}

/* Lightbox */
.lightbox {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--md-scrim-heavy);
    z-index: 1000;
    display: none;
    flex-direction: column;
}
.lightbox.active { display: flex; }
.lightbox-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem var(--spacing-md);
    background-color: var(--md-scrim-light);
    z-index: 10;
}
.lightbox-title {
    color: var(--md-white);
    font-size: 0.9rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 300px;
}
.lightbox-actions { display: flex; gap: var(--spacing-xs); }
.lightbox-btn {
    background: var(--md-state-hover-on-surface);
    border: none;
    color: var(--md-white);
    width: 40px;
    height: 40px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
}
.lightbox-btn:hover { background: var(--md-state-pressed-on-surface); }
.lightbox-btn.active { color: var(--md-favorite); }
.lightbox-btn.danger:hover { background-color: var(--md-error-container); color: var(--md-error); }
.lightbox-close {
    background: none;
    border: none;
    color: var(--md-white);
    font-size: 1.5rem;
    cursor: pointer;
    padding: var(--spacing-sm);
    line-height: 1;
    margin-left: var(--spacing-sm);
    transition: color var(--transition-fast);
}
.lightbox-close:hover { color: var(--md-primary); }
.lightbox-content {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
}
.lightbox-content img {
    max-width: calc(100% - 120px);
    max-height: 100%;
    object-fit: contain;
    user-select: none;
    border-radius: var(--radius-sm);
}
.lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: var(--md-scrim-light);
    border: none;
    color: var(--md-white);
    width: 50px;
    height: 80px;
    cursor: pointer;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
    z-index: 5;
}
.lightbox-nav:hover { background: var(--md-state-pressed-on-surface); }
.lightbox-nav:disabled { opacity: 0.3; cursor: default; }
.lightbox-nav.prev { left: 0; border-radius: 0 var(--radius-sm) var(--radius-sm) 0; }
.lightbox-nav.next { right: 0; border-radius: var(--radius-sm) 0 0 var(--radius-sm); }
.lightbox-footer {
    padding: 0.75rem var(--spacing-md);
    background: linear-gradient(transparent, var(--md-scrim-heavy));
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.lightbox-info { flex: 1; }
.lightbox-info h3 { margin-bottom: var(--spacing-xs); font-size: 0.9rem; }
.lightbox-info .meta { font-size: 0.8rem; color: var(--text-secondary); }
.lightbox-counter { color: var(--text-secondary); font-size: 0.85rem; }

/* Status Bar */
.status-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: var(--md-surface-container);
    border-top: 1px solid var(--border);
    padding: var(--spacing-sm) var(--spacing-xl);
    display: none;
    align-items: center;
    justify-content: space-between;
    font-size: 0.75rem;
    z-index: 100;
}
.status-bar.active { display: flex; }
.status-bar .status-info { display: flex; gap: var(--spacing-lg); }
.status-bar .status-item { display: flex; align-items: center; gap: var(--spacing-sm); }
.status-bar .status-label { color: var(--text-muted); }
.status-bar .status-value { color: var(--text-primary); font-weight: 500; }
.status-bar .progress-bar {
    width: 200px;
    height: 4px;
    background-color: var(--md-surface-container-high);
    border-radius: 2px;
    overflow: hidden;
}
.status-bar .progress-bar .progress {
    height: 100%;
    background-color: var(--md-primary);
    transition: width var(--transition-slow);
}

@media (max-width: 900px) {
    .sidebar { width: 240px; }
    .grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
}
@media (max-width: 768px) {
    .main-nav { display: none; }
    .sidebar { display: none; }
    .bulk-actions-bar { flex-direction: column; gap: 0.75rem; }
}
{{end}}

{{define "content"}}
<!-- Bulk Actions Bar -->
<div class="bulk-actions-bar" id="bulk-actions-bar">
    <div class="bulk-info">
        <span>Выбрано: <strong id="selected-count">0</strong></span>
        <button class="md-button md-button-text" onclick="selectAll()">Выбрать все</button>
        <button class="md-button md-button-text" onclick="deselectAll()">Снять выбор</button>
    </div>
    <div class="bulk-buttons">
        <button class="md-button md-button-tonal" onclick="bulkFavorite(true)">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
            В избранное
        </button>
        {{if .CanEdit}}<button class="md-button md-button-tonal" onclick="showAddToAlbumModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            В альбом
        </button>{{end}}
        {{if .CanEdit}}<button class="md-button md-button-tonal" onclick="showAddTagsModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58s1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/></svg>
            Теги
        </button>{{end}}
        <button class="md-button md-button-filled" onclick="bulkDownload()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z"/></svg>
            Скачать ZIP
        </button>
        {{if .IsAdmin}}<button class="md-button md-button-outlined" style="color: var(--md-error); border-color: var(--md-error);" onclick="bulkDelete()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            Удалить
        </button>{{end}}
    </div>
</div>

<div class="container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-title">Периоды</span>
        </div>
        <div class="all-photos-btn" onclick="loadAllMedia()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M22 16V4c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2zm-11-4l2.03 2.71L16 11l4 5H8l3-4zM2 6v14c0 1.1.9 2 2 2h14v-2H4V6H2z"/></svg>
            Все фото
        </div>
        <ul class="timeline-list">
            {{$currentYear := ""}}
            {{range .Timeline}}
            {{$year := slice .Date 0 4}}
            {{if ne $year $currentYear}}
            <li class="year-header">
                <span>{{$year}}</span>
                <input type="checkbox" class="year-select" data-year="{{$year}}" onchange="selectYear('{{$year}}', this.checked)" title="Выбрать весь год">
            </li>
            {{$currentYear = $year}}
            {{end}}
            <li class="timeline-item" data-period="{{.Date}}" data-count="{{.MediaCount}}"
                hx-get="/timeline/{{.Date}}"
                hx-target="#content"
                onclick="setActive(this)">
                <div class="timeline-item-info">
                    <span class="timeline-label">{{.Label}}</span>
                    <span class="timeline-count">{{.MediaCount}}</span>
                </div>
                <input type="checkbox" class="period-checkbox" data-period="{{.Date}}" onclick="event.stopPropagation(); selectPeriod('{{.Date}}', this.checked)" title="Выбрать период">
            </li>
            {{end}}
        </ul>
    </aside>

    <main class="main">
        <div class="main-header">
            <div>
                <h1 class="main-title" id="content-title">Галерея</h1>
                <p class="main-subtitle" id="content-subtitle">Выберите период слева</p>
            </div>
            <div class="main-actions">
                <button class="md-button md-button-outlined" id="select-mode-btn" onclick="toggleSelectMode()">Выбрать</button>
            </div>
        </div>
        <div id="content">
            {{if .Timeline}}
            <div class="empty-state">
                <h3>Выберите период</h3>
                <p>Нажмите на месяц в списке слева для просмотра фотографий</p>
            </div>
            {{else}}
            <div class="empty-state">
                <h3>Пока ничего нет</h3>
                <p>Добавьте медиа-файлы в директорию галереи</p>
            </div>
            {{end}}
        </div>
    </main>
</div>

<!-- Status Bar -->
<div class="status-bar" id="status-bar">
    <div class="status-info">
        <div class="status-item">
            <span class="spinner" style="width: 12px; height: 12px;"></span>
            <span class="status-label">Обработка:</span>
            <span class="status-value" id="queue-processing">0</span>
        </div>
        <div class="status-item">
            <span class="status-label">В очереди:</span>
            <span class="status-value" id="queue-pending">0</span>
        </div>
        <div class="status-item">
            <span class="status-label">Готово:</span>
            <span class="status-value" id="queue-completed">0</span>
        </div>
    </div>
    <div class="progress-bar">
        <div class="progress" id="queue-progress" style="width: 0%"></div>
    </div>
</div>
{{end}}

{{define "modals"}}
<!-- Lightbox -->
<div class="lightbox" id="lightbox">
    <div class="lightbox-header">
        <span class="lightbox-title" id="lightbox-title"></span>
        <div class="lightbox-actions">
            <button class="lightbox-btn" id="lb-favorite-btn" onclick="lbToggleFavorite()" title="В избранное"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="icon-star-outline"><path d="M22 9.24l-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03L22 9.24zM12 15.4l-3.76 2.27 1-4.28-3.32-2.88 4.38-.38L12 6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28L12 15.4z"/></svg><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="icon-star-filled" style="display:none"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></button>
            {{if .CanEdit}}<button class="lightbox-btn" onclick="lbShowAlbumModal()" title="Добавить в альбом"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/></svg></button>{{end}}
            {{if .CanEdit}}<button class="lightbox-btn" onclick="lbShowTagsModal()" title="Добавить теги"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58s1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/></svg></button>{{end}}
            <button class="lightbox-btn" onclick="lbDownload()" title="Скачать"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z"/></svg></button>
            {{if .IsAdmin}}<button class="lightbox-btn danger" onclick="lbDelete()" title="Удалить"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>{{end}}
            <button class="lightbox-close" onclick="closeLightbox()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
        </div>
    </div>
    <div class="lightbox-content">
        <button class="lightbox-nav prev" id="lb-prev" onclick="lbNavigate(-1)"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg></button>
        <img id="lightbox-img" src="" alt="">
        <button class="lightbox-nav next" id="lb-next" onclick="lbNavigate(1)"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></button>
    </div>
    <div class="lightbox-footer">
        <div class="lightbox-info" id="lightbox-info"></div>
        <span class="lightbox-counter" id="lightbox-counter"></span>
    </div>
</div>

<!-- Album Modal -->
<div class="modal" id="album-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Добавить в альбом</h2>
            <button class="modal-close" onclick="closeModal('album-modal')"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Выберите альбом</label>
                <select class="form-select" id="album-select"></select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="md-button md-button-text" onclick="closeModal('album-modal')">Отмена</button>
            <button class="md-button md-button-filled" onclick="addToAlbum()">Добавить</button>
        </div>
    </div>
</div>

<!-- Tags Modal -->
<div class="modal" id="tags-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Добавить теги</h2>
            <button class="modal-close" onclick="closeModal('tags-modal')"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Теги (через запятую)</label>
                <input type="text" class="form-input" id="tags-input" placeholder="природа, лето, отпуск">
            </div>
        </div>
        <div class="modal-footer">
            <button class="md-button md-button-text" onclick="closeModal('tags-modal')">Отмена</button>
            <button class="md-button md-button-filled" onclick="addTags()">Добавить</button>
        </div>
    </div>
</div>

<!-- Lightbox Album Modal -->
<div class="modal" id="lb-album-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Добавить в альбом</h2>
            <button class="modal-close" onclick="closeModal('lb-album-modal')"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Выберите альбом</label>
                <select class="form-select" id="lb-album-select"></select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="md-button md-button-text" onclick="closeModal('lb-album-modal')">Отмена</button>
            <button class="md-button md-button-filled" onclick="lbAddToAlbum()">Добавить</button>
        </div>
    </div>
</div>

<!-- Lightbox Tags Modal -->
<div class="modal" id="lb-tags-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Добавить теги</h2>
            <button class="modal-close" onclick="closeModal('lb-tags-modal')"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Теги (через запятую)</label>
                <input type="text" class="form-input" id="lb-tags-input" placeholder="природа, лето, отпуск">
            </div>
        </div>
        <div class="modal-footer">
            <button class="md-button md-button-text" onclick="closeModal('lb-tags-modal')">Отмена</button>
            <button class="md-button md-button-filled" onclick="lbAddTags()">Добавить</button>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
// === State ===
let selectMode = false;
let selectedMedia = new Set();
let currentPeriod = null;
let isAllMode = true;

// === Favorites Set (loaded once from server) ===
const favSet = new Set([{{range $id, $_ := .FavSet}}"{{$id}}",{{end}}]);

function updateFavoriteBadges() {
    document.querySelectorAll('.media-card').forEach(card => {
        const badge = card.querySelector('.favorite-badge');
        if (badge) {
            const isFav = favSet.has(card.dataset.id);
            badge.classList.toggle('active', isFav);
            card.dataset.favorite = isFav;
        }
    });
}

// === Timeline Navigation ===
function setActive(el) {
    document.querySelectorAll('.timeline-item').forEach(item => item.classList.remove('active'));
    el.classList.add('active');
    currentPeriod = el.dataset.period;
    isAllMode = false;
    const label = el.querySelector('.timeline-label').textContent;
    const count = el.dataset.count;
    document.getElementById('content-title').textContent = label;
    document.getElementById('content-subtitle').textContent = count + ' фото';
}

function loadAllMedia() {
    isAllMode = true;
    currentPeriod = null;
    document.querySelectorAll('.timeline-item').forEach(item => item.classList.remove('active'));
    document.getElementById('content-title').textContent = 'Все фото';
    document.getElementById('content-subtitle').textContent = 'Загрузка...';
    fetch('/timeline/all', { headers: { 'Accept': 'text/html' } })
        .then(r => r.text())
        .then(html => {
            document.getElementById('content').innerHTML = html;
            observeImages();
            updateFavoriteBadges();
            const count = document.querySelectorAll('.media-card').length;
            document.getElementById('content-subtitle').textContent = count + ' фото';
        })
        .catch(() => {
            document.getElementById('content').innerHTML = '<div class="empty-state"><h3>Ошибка загрузки</h3></div>';
        });
}

function scrollToPeriod(period) {
    const section = document.querySelector('.section[data-period="' + period + '"]');
    if (section) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        document.querySelectorAll('.timeline-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.period === period) item.classList.add('active');
        });
    }
}

// === Lazy Loading ===
function observeImages() {
    const images = document.querySelectorAll('.media-card img[data-src]');
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.classList.remove('loading');
                observer.unobserve(img);
            }
        });
    }, { rootMargin: '100px' });
    images.forEach(img => { img.classList.add('loading'); observer.observe(img); });
}

document.body.addEventListener('htmx:afterSwap', function() {
    observeImages();
    updateFavoriteBadges();
    if (selectMode) {
        document.querySelectorAll('.media-card').forEach(card => {
            if (selectedMedia.has(card.dataset.id)) card.classList.add('selected');
        });
    }
});

// === Selection Mode ===
function toggleSelectMode() {
    selectMode = !selectMode;
    document.body.classList.toggle('select-mode', selectMode);
    document.getElementById('bulk-actions-bar').classList.toggle('active', selectMode);
    document.getElementById('select-mode-btn').textContent = selectMode ? 'Отмена' : 'Выбрать';
    if (!selectMode) deselectAll();
}

function updateSelectedCount() {
    document.getElementById('selected-count').textContent = selectedMedia.size;
}

function selectAll() {
    document.querySelectorAll('.media-card').forEach(card => {
        const id = card.dataset.id;
        if (id) { selectedMedia.add(id); card.classList.add('selected'); }
    });
    updateSelectedCount();
    showToast('Выбрано: ' + selectedMedia.size, 'info');
}

function deselectAll() {
    selectedMedia.clear();
    document.querySelectorAll('.media-card.selected').forEach(card => card.classList.remove('selected'));
    document.querySelectorAll('.period-checkbox').forEach(cb => cb.checked = false);
    document.querySelectorAll('.year-select').forEach(cb => cb.checked = false);
    updateSelectedCount();
}

function selectPeriod(period, checked) {
    if (!selectMode) toggleSelectMode();
    fetch('/timeline/' + period, { headers: { 'Accept': 'application/json' } })
        .then(r => r.json())
        .then(media => {
            if (media) {
                media.forEach(m => { if (checked) selectedMedia.add(m.id); else selectedMedia.delete(m.id); });
                document.querySelectorAll('.media-card').forEach(card => {
                    card.classList.toggle('selected', selectedMedia.has(card.dataset.id));
                });
                updateSelectedCount();
            }
        });
}

function selectYear(year, checked) {
    if (!selectMode) toggleSelectMode();
    document.querySelectorAll('.timeline-item').forEach(item => {
        if (item.dataset.period && item.dataset.period.startsWith(year)) {
            const cb = item.querySelector('.period-checkbox');
            if (cb && cb.checked !== checked) { cb.checked = checked; selectPeriod(item.dataset.period, checked); }
        }
    });
}

document.addEventListener('click', function(e) {
    if (!selectMode) return;
    const card = e.target.closest('.media-card');
    if (!card || e.target.classList.contains('favorite-badge')) return;
    e.preventDefault(); e.stopPropagation();
    const id = card.dataset.id;
    if (!id) return;
    if (selectedMedia.has(id)) { selectedMedia.delete(id); card.classList.remove('selected'); }
    else { selectedMedia.add(id); card.classList.add('selected'); }
    updateSelectedCount();
});

// === Bulk Operations ===
function getSelectedIds() { return Array.from(selectedMedia); }

function bulkFavorite(isFavorite) {
    const ids = getSelectedIds();
    if (ids.length === 0) { showToast('Сначала выберите файлы', 'warning'); return; }
    fetch('/api/bulk/favorite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ media_ids: ids, is_favorite: isFavorite })
    })
    .then(r => r.json())
    .then(data => { showToast('Добавлено в избранное: ' + data.count, 'success'); deselectAll(); })
    .catch(err => showToast('Ошибка: ' + err.message, 'error'));
}

function bulkDownload() {
    const ids = getSelectedIds();
    if (ids.length === 0) { showToast('Сначала выберите файлы', 'warning'); return; }
    showToast('Подготовка архива...', 'info');
    fetch('/api/bulk/download', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ media_ids: ids })
    })
    .then(r => r.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'photos.zip';
        document.body.appendChild(a); a.click(); a.remove();
        window.URL.revokeObjectURL(url);
        showToast('Скачивание начато', 'success');
    })
    .catch(err => showToast('Ошибка: ' + err.message, 'error'));
}

function bulkDelete() {
    const ids = getSelectedIds();
    if (ids.length === 0) { showToast('Сначала выберите файлы', 'warning'); return; }
    if (!confirm('Удалить ' + ids.length + ' файлов?')) return;
    fetch('/api/bulk/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ media_ids: ids })
    })
    .then(r => r.json())
    .then(data => {
        showToast('Удалено: ' + data.count, 'success');
        ids.forEach(id => {
            const card = document.querySelector('.media-card[data-id="' + id + '"]');
            if (card) { updatePeriodCounterForCard(card); card.remove(); }
        });
        deselectAll(); toggleSelectMode();
    })
    .catch(err => showToast('Ошибка: ' + err.message, 'error'));
}

function showAddToAlbumModal() {
    const ids = getSelectedIds();
    if (ids.length === 0) { showToast('Сначала выберите файлы', 'warning'); return; }
    fetch('/api/albums').then(r => r.json()).then(albums => {
        const select = document.getElementById('album-select');
        select.innerHTML = '<option value="">Выберите альбом</option>';
        if (albums) albums.forEach(a => select.innerHTML += '<option value="' + a.id + '">' + a.name + '</option>');
        document.getElementById('album-modal').classList.add('active');
    });
}

function addToAlbum() {
    const ids = getSelectedIds();
    const albumId = document.getElementById('album-select').value;
    if (!albumId) { showToast('Выберите альбом', 'warning'); return; }
    if (ids.length === 0) { showToast('Сначала выберите файлы', 'warning'); return; }
    fetch('/api/bulk/album', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ media_ids: ids, album_id: albumId })
    })
    .then(r => r.json())
    .then(data => { showToast('Добавлено в альбом: ' + data.count, 'success'); closeModal('album-modal'); deselectAll(); })
    .catch(err => showToast('Ошибка: ' + err.message, 'error'));
}

function showAddTagsModal() {
    if (getSelectedIds().length === 0) { showToast('Сначала выберите файлы', 'warning'); return; }
    document.getElementById('tags-modal').classList.add('active');
}

function addTags() {
    const ids = getSelectedIds();
    const tags = document.getElementById('tags-input').value.split(',').map(t => t.trim()).filter(t => t);
    if (tags.length === 0) { showToast('Введите хотя бы один тег', 'warning'); return; }
    if (ids.length === 0) { showToast('Сначала выберите файлы', 'warning'); return; }
    fetch('/api/bulk/tags', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ media_ids: ids, tags: tags })
    })
    .then(r => r.json())
    .then(data => { showToast('Теги добавлены: ' + data.count, 'success'); closeModal('tags-modal'); document.getElementById('tags-input').value = ''; deselectAll(); })
    .catch(err => showToast('Ошибка: ' + err.message, 'error'));
}

// === Lightbox ===
let lbMediaList = [], lbCurrentIndex = 0, lbCurrentMedia = null, lbTouchStartX = 0, lbTouchEndX = 0;

function openLightbox(id, filename, meta) {
    if (selectMode) return;
    lbMediaList = [];
    document.querySelectorAll('.media-card').forEach((card, index) => {
        const mediaId = card.dataset.id;
        if (mediaId) {
            lbMediaList.push({
                id: mediaId,
                filename: card.dataset.filename || card.querySelector('img')?.alt || '',
                meta: card.dataset.meta || ''
            });
            if (mediaId === id) lbCurrentIndex = lbMediaList.length - 1;
        }
    });
    lbShowMedia(id, filename, meta);
    document.getElementById('lightbox').classList.add('active');
    document.body.style.overflow = 'hidden';
    lbUpdateNavButtons();
}

function lbShowMedia(id, filename, meta) {
    const isFavorite = favSet.has(id);
    lbCurrentMedia = { id, filename, meta, isFavorite };
    const img = document.getElementById('lightbox-img');
    document.getElementById('lightbox-title').textContent = filename;
    img.src = '/media/' + id + '/thumb/large';
    document.getElementById('lightbox-info').innerHTML = '<h3>' + filename + '</h3>' + (meta ? '<div class="meta">' + meta + '</div>' : '');
    const favBtn = document.getElementById('lb-favorite-btn');
    favBtn.querySelector('.icon-star-outline').style.display = isFavorite ? 'none' : 'block';
    favBtn.querySelector('.icon-star-filled').style.display = isFavorite ? 'block' : 'none';
    favBtn.classList.toggle('active', isFavorite);
    document.getElementById('lightbox-counter').textContent = lbMediaList.length > 0 ? (lbCurrentIndex + 1) + ' / ' + lbMediaList.length : '';
    const fullImg = new Image();
    fullImg.onload = function() { img.src = '/media/' + id; };
    fullImg.src = '/media/' + id;
}

function lbUpdateNavButtons() {
    document.getElementById('lb-prev').disabled = lbCurrentIndex <= 0;
    document.getElementById('lb-next').disabled = lbCurrentIndex >= lbMediaList.length - 1;
}

function lbNavigate(direction) {
    const newIndex = lbCurrentIndex + direction;
    if (newIndex < 0 || newIndex >= lbMediaList.length) return;
    lbCurrentIndex = newIndex;
    const media = lbMediaList[lbCurrentIndex];
    lbShowMedia(media.id, media.filename, media.meta);
    lbUpdateNavButtons();
}

function closeLightbox() {
    document.getElementById('lightbox').classList.remove('active');
    document.body.style.overflow = '';
    lbCurrentMedia = null;
}

document.addEventListener('keydown', function(e) {
    if (!document.getElementById('lightbox').classList.contains('active')) return;
    if (e.key === 'Escape') closeLightbox();
    else if (e.key === 'ArrowLeft') { lbNavigate(-1); e.preventDefault(); }
    else if (e.key === 'ArrowRight') { lbNavigate(1); e.preventDefault(); }
});

document.getElementById('lightbox').addEventListener('click', function(e) {
    if (e.target.classList.contains('lightbox-content')) closeLightbox();
});

document.getElementById('lightbox').addEventListener('touchstart', function(e) { lbTouchStartX = e.changedTouches[0].screenX; }, { passive: true });
document.getElementById('lightbox').addEventListener('touchend', function(e) {
    lbTouchEndX = e.changedTouches[0].screenX;
    const diff = lbTouchStartX - lbTouchEndX;
    if (Math.abs(diff) > 50) lbNavigate(diff > 0 ? 1 : -1);
}, { passive: true });

// === Lightbox Actions ===
function lbToggleFavorite() {
    if (!lbCurrentMedia) return;
    fetch('/api/media/' + lbCurrentMedia.id + '/favorite', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            // Обновляем локальный Set
            if (data.is_favorite) favSet.add(lbCurrentMedia.id); else favSet.delete(lbCurrentMedia.id);
            // Обновляем lightbox
            lbCurrentMedia.isFavorite = data.is_favorite;
            const favBtn = document.getElementById('lb-favorite-btn');
            favBtn.querySelector('.icon-star-outline').style.display = data.is_favorite ? 'none' : 'block';
            favBtn.querySelector('.icon-star-filled').style.display = data.is_favorite ? 'block' : 'none';
            favBtn.classList.toggle('active', data.is_favorite);
            if (lbMediaList[lbCurrentIndex]) lbMediaList[lbCurrentIndex].isFavorite = data.is_favorite;
            // Обновляем карточку в сетке
            const card = document.querySelector('.media-card[data-id="' + lbCurrentMedia.id + '"]');
            if (card) {
                card.dataset.favorite = data.is_favorite;
                const badge = card.querySelector('.favorite-badge');
                if (badge) badge.classList.toggle('active', data.is_favorite);
            }
            showToast(data.is_favorite ? 'Добавлено в избранное' : 'Удалено из избранного', 'success');
        })
        .catch(err => showToast('Ошибка: ' + err.message, 'error'));
}

function lbShowAlbumModal() {
    if (!lbCurrentMedia) return;
    fetch('/api/albums').then(r => r.json()).then(albums => {
        const select = document.getElementById('lb-album-select');
        select.innerHTML = '<option value="">Выберите альбом</option>';
        if (albums) albums.forEach(a => select.innerHTML += '<option value="' + a.id + '">' + a.name + '</option>');
        document.getElementById('lb-album-modal').classList.add('active');
    });
}

function lbAddToAlbum() {
    if (!lbCurrentMedia) return;
    const albumId = document.getElementById('lb-album-select').value;
    if (!albumId) { showToast('Выберите альбом', 'warning'); return; }
    fetch('/api/bulk/album', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ media_ids: [lbCurrentMedia.id], album_id: albumId })
    })
    .then(r => r.json())
    .then(() => { showToast('Добавлено в альбом', 'success'); closeModal('lb-album-modal'); })
    .catch(err => showToast('Ошибка: ' + err.message, 'error'));
}

function lbShowTagsModal() {
    if (!lbCurrentMedia) return;
    document.getElementById('lb-tags-input').value = '';
    document.getElementById('lb-tags-modal').classList.add('active');
}

function lbAddTags() {
    if (!lbCurrentMedia) return;
    const tags = document.getElementById('lb-tags-input').value.split(',').map(t => t.trim()).filter(t => t);
    if (tags.length === 0) { showToast('Введите хотя бы один тег', 'warning'); return; }
    fetch('/api/bulk/tags', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ media_ids: [lbCurrentMedia.id], tags: tags })
    })
    .then(r => r.json())
    .then(() => { showToast('Теги добавлены', 'success'); closeModal('lb-tags-modal'); })
    .catch(err => showToast('Ошибка: ' + err.message, 'error'));
}

function lbDownload() {
    if (!lbCurrentMedia) return;
    const a = document.createElement('a');
    a.href = '/media/' + lbCurrentMedia.id;
    a.download = lbCurrentMedia.filename;
    document.body.appendChild(a); a.click(); a.remove();
    showToast('Скачивание: ' + lbCurrentMedia.filename, 'info');
}

function updatePeriodCounterForCard(card) {
    if (!card) return;
    let period = null;
    const section = card.closest('.section');
    if (isAllMode) {
        const sectionWithPeriod = card.closest('.section[data-period]');
        if (sectionWithPeriod) {
            period = sectionWithPeriod.dataset.period;
            const periodCount = sectionWithPeriod.querySelector('.period-count');
            if (periodCount) {
                const match = periodCount.textContent.match(/\d+/);
                if (match) {
                    let count = Math.max(0, parseInt(match[0]) - 1);
                    periodCount.textContent = '(' + count + ')';
                    if (count === 0) sectionWithPeriod.remove();
                }
            }
        }
    } else {
        period = currentPeriod;
        if (section) {
            const sectionTitle = section.querySelector('.section-title');
            if (sectionTitle) {
                const match = sectionTitle.textContent.match(/\((\d+)\)/);
                if (match) {
                    let count = Math.max(0, parseInt(match[1]) - 1);
                    sectionTitle.textContent = sectionTitle.textContent.replace(/\(\d+\)/, '(' + count + ')');
                    const subtitle = document.getElementById('content-subtitle');
                    if (subtitle) subtitle.textContent = count + ' фото';
                }
            }
        }
    }
    if (!period) return;
    const menuItem = document.querySelector('.timeline-item[data-period="' + period + '"]');
    if (menuItem) {
        let count = Math.max(0, parseInt(menuItem.dataset.count) - 1);
        menuItem.dataset.count = count;
        const countSpan = menuItem.querySelector('.timeline-count');
        if (countSpan) countSpan.textContent = count;
        if (count === 0) {
            menuItem.remove();
            const year = period.substring(0, 4);
            if (document.querySelectorAll('.timeline-item[data-period^="' + year + '"]').length === 0) {
                document.querySelectorAll('.year-header').forEach(header => {
                    if (header.querySelector('span')?.textContent === year) header.remove();
                });
            }
        }
    }
}

function lbDelete() {
    if (!lbCurrentMedia) return;
    if (!confirm('Удалить "' + lbCurrentMedia.filename + '" из базы данных?')) return;
    const deletedId = lbCurrentMedia.id;
    fetch('/api/bulk/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ media_ids: [deletedId] })
    })
    .then(r => r.json())
    .then(() => {
        showToast('Удалено', 'success');
        lbMediaList.splice(lbCurrentIndex, 1);
        const card = document.querySelector('.media-card[data-id="' + deletedId + '"]');
        updatePeriodCounterForCard(card);
        if (card) card.remove();
        if (lbMediaList.length === 0) closeLightbox();
        else {
            if (lbCurrentIndex >= lbMediaList.length) lbCurrentIndex = lbMediaList.length - 1;
            const media = lbMediaList[lbCurrentIndex];
            lbShowMedia(media.id, media.filename, media.meta);
            lbUpdateNavButtons();
        }
    })
    .catch(err => showToast('Ошибка: ' + err.message, 'error'));
}

// === Favorite Toggle ===
function toggleFavorite(id, event) {
    event.stopPropagation();
    fetch('/api/media/' + id + '/favorite', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            // Обновляем локальный Set
            if (data.is_favorite) favSet.add(id); else favSet.delete(id);
            // Обновляем UI - ищем badge через closest так как event.target может быть svg/path
            const badge = event.target.closest('.favorite-badge');
            if (badge) badge.classList.toggle('active', data.is_favorite);
            const card = event.target.closest('.media-card');
            if (card) card.dataset.favorite = data.is_favorite;
        })
        .catch(err => showToast('Ошибка: ' + err.message, 'error'));
}

// === Queue Status ===
let queuePollInterval = null;

function updateQueueStatus() {
    fetch('/api/queue').then(r => r.json()).then(data => {
        const statusBar = document.getElementById('status-bar');
        const processing = data.active_workers || 0;
        const pending = data.queued_tasks || 0;
        const completed = data.completed_tasks || 0;
        const total = data.total_tasks || 0;
        document.getElementById('queue-processing').textContent = processing;
        document.getElementById('queue-pending').textContent = pending;
        document.getElementById('queue-completed').textContent = completed;
        if (total > 0) document.getElementById('queue-progress').style.width = Math.round((completed / total) * 100) + '%';
        if (processing > 0 || pending > 0) {
            statusBar.classList.add('active');
            if (!queuePollInterval) queuePollInterval = setInterval(updateQueueStatus, 2000);
        } else {
            statusBar.classList.remove('active');
            if (queuePollInterval) { clearInterval(queuePollInterval); queuePollInterval = null; }
            if (total > 0) observeImages();
        }
    }).catch(err => console.log('Queue status error:', err));
}

// === Init ===
document.addEventListener('DOMContentLoaded', function() {
    observeImages();
    updateQueueStatus();
    loadAllMedia();
    setTimeout(function checkQueue() { updateQueueStatus(); setTimeout(checkQueue, 5000); }, 5000);
});
{{end}}
